name: Bench (containerized)

on:
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish built image to registry if secrets are configured (true/false)'
        required: false
        default: 'false'
  push:
    branches:
      - main
      - test/infrastructure
  pull_request:
    branches:
      - main
  schedule:
    # daily at 02:00 UTC - adjust as needed
    - cron: '0 2 * * *'

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build GitZoom container
        run: |
          docker build -t gitzoom/cli:bench-${{ github.sha }} -f tools/gitzoom-cli/Dockerfile .

      - name: Run measurement harness in container
        run: |
          CONTAINER_ID=$(docker create gitzoom/cli:bench-${{ github.sha }})
          docker cp . $CONTAINER_ID:/workspace
          docker start -a $CONTAINER_ID || true
          # copy out artifacts if the harness wrote them to /workspace/artifacts
          docker cp $CONTAINER_ID:/workspace/artifacts ./artifacts || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bench-artifacts-${{ github.sha }}
          path: artifacts/**
      # publishing is handled in a separate job to avoid evaluating secrets at workflow-parse time

  publish:
    name: Publish images (manual)
    needs: build-and-run
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.publish == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Publish to GHCR (if GHCR_TOKEN set)
        run: |
          if [ -z "${{ secrets.GHCR_TOKEN }}" ]; then
            echo "GHCR_TOKEN not set; skipping GHCR publish"
            exit 0
          fi
          echo "Logging into GHCR"
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker tag gitzoom/cli:bench-${{ github.sha }} ghcr.io/${{ github.repository_owner }}/gitzoom/cli:${{ github.sha }}
          docker push ghcr.io/${{ github.repository_owner }}/gitzoom/cli:${{ github.sha }}

      - name: Publish to Docker Hub (if DOCKERHUB creds set)
        run: |
          if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ] || [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "Docker Hub credentials not set; skipping Docker Hub publish"
            exit 0
          fi
          echo "Logging into Docker Hub"
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          docker tag gitzoom/cli:bench-${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/gitzoom-cli:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/gitzoom-cli:${{ github.sha }}
