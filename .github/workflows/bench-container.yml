name: Bench (containerized)

on:
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish built image to registry if secrets are configured (true/false)'
        required: false
        default: 'false'
  push:
    branches:
      - main
      - test/infrastructure
  pull_request:
    branches:
      - main
  schedule:
    # daily at 02:00 UTC - adjust as needed
    - cron: '0 2 * * *'

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build GitZoom container
        run: |
          docker build -t gitzoom/cli:bench-${{ github.sha }} -f tools/gitzoom-cli/Dockerfile .

      - name: Run measurement harness in container
        run: |
          CONTAINER_ID=$(docker create gitzoom/cli:bench-${{ github.sha }})
          docker cp . $CONTAINER_ID:/workspace
          docker start -a $CONTAINER_ID || true
          # copy out artifacts if the harness wrote them to /workspace/artifacts
          docker cp $CONTAINER_ID:/workspace/artifacts ./artifacts || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bench-artifacts-${{ github.sha }}
          path: artifacts/**

      - name: Optionally publish image to GHCR
        if: ${{ github.event.inputs.publish == 'true' && secrets.GHCR_TOKEN != '' }}
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Push image to GHCR (if enabled)
        if: ${{ github.event.inputs.publish == 'true' && secrets.GHCR_TOKEN != '' }}
        run: |
          docker tag gitzoom/cli:bench-${{ github.sha }} ghcr.io/${{ github.repository_owner }}/gitzoom/cli:${{ github.sha }}
          docker push ghcr.io/${{ github.repository_owner }}/gitzoom/cli:${{ github.sha }}

      - name: Optionally publish image to Docker Hub
        if: ${{ github.event.inputs.publish == 'true' && secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != '' }}
        uses: docker/login-action@v2
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push image to Docker Hub (if enabled)
        if: ${{ github.event.inputs.publish == 'true' && secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != '' }}
        run: |
          docker tag gitzoom/cli:bench-${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/gitzoom-cli:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/gitzoom-cli:${{ github.sha }}
